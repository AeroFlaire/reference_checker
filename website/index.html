<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Reference Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .drop-zone { border: 2px dashed #334155; transition: all 0.3s ease; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #3b82f6; background-color: #1e293b; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        /* Smooth rotation for the dropdown arrow */
        .rotate-icon { transition: transform 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

    <div class="w-full max-w-4xl">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-blue-500 mb-2">Reference Checker AI</h1>
            <p class="text-slate-400">Upload a PDF to extract and verify citations against OpenAlex.</p>
        </div>

        <div id="upload-section" class="mb-8">
            <div class="drop-zone rounded-xl p-10 text-center cursor-pointer" id="drop-area">
                <input type="file" id="file-input" class="hidden" accept=".pdf">
                <i class="fas fa-cloud-upload-alt text-5xl text-slate-500 mb-4"></i>
                <h3 class="text-xl font-semibold">Drop your PDF here</h3>
                <p class="text-slate-400 mt-2">or click to browse</p>
            </div>
        </div>

        <div id="loading-section" class="hidden text-center py-10">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <h3 class="text-xl font-semibold animate-pulse">Analyzing References...</h3>
            <p class="text-slate-400 mt-2">This may take a moment.</p>
        </div>

        <div id="results-section" class="hidden space-y-6">
            
            <div class="card rounded-lg overflow-hidden">
                <div onclick="toggleSection('list-verified')" class="bg-green-900/30 p-4 border-b border-green-900/50 flex justify-between items-center cursor-pointer hover:bg-green-900/40 transition">
                    <h2 class="text-xl font-bold text-green-400"><i class="fas fa-check-circle mr-2"></i>Verified Matches <span id="count-verified" class="bg-green-900 text-xs px-2 py-1 rounded ml-2">0</span></h2>
                    <i id="icon-list-verified" class="fas fa-chevron-down rotate-icon text-green-400"></i>
                </div>
                <div id="list-verified" class="p-4 space-y-4 hidden"></div>
            </div>

            <div class="card rounded-lg overflow-hidden">
                <div onclick="toggleSection('list-mismatch')" class="bg-orange-900/30 p-4 border-b border-orange-900/50 flex justify-between items-center cursor-pointer hover:bg-orange-900/40 transition">
                    <h2 class="text-xl font-bold text-orange-400"><i class="fas fa-history mr-2"></i>Edition / Year Mismatch <span id="count-mismatch" class="bg-orange-900 text-xs px-2 py-1 rounded ml-2">0</span></h2>
                    <i id="icon-list-mismatch" class="fas fa-chevron-down rotate-icon text-orange-400"></i>
                </div>
                <div id="list-mismatch" class="p-4 space-y-4"></div>
            </div>

            <div class="card rounded-lg overflow-hidden">
                <div onclick="toggleSection('list-flawed')" class="bg-yellow-900/30 p-4 border-b border-yellow-900/50 flex justify-between items-center cursor-pointer hover:bg-yellow-900/40 transition">
                    <h2 class="text-xl font-bold text-yellow-400"><i class="fas fa-exclamation-triangle mr-2"></i>Flawed / Weak Matches <span id="count-flawed" class="bg-yellow-900 text-xs px-2 py-1 rounded ml-2">0</span></h2>
                    <i id="icon-list-flawed" class="fas fa-chevron-down rotate-icon text-yellow-400"></i>
                </div>
                <div id="list-flawed" class="p-4 space-y-4"></div>
            </div>

            <div class="card rounded-lg overflow-hidden">
                <div onclick="toggleSection('list-notfound')" class="bg-red-900/30 p-4 border-b border-red-900/50 flex justify-between items-center cursor-pointer hover:bg-red-900/40 transition">
                    <h2 class="text-xl font-bold text-red-400"><i class="fas fa-times-circle mr-2"></i>Not Found <span id="count-notfound" class="bg-red-900 text-xs px-2 py-1 rounded ml-2">0</span></h2>
                    <i id="icon-list-notfound" class="fas fa-chevron-down rotate-icon text-red-400"></i>
                </div>
                <div id="list-notfound" class="p-4 space-y-4"></div>
            </div>

            <div class="card rounded-lg overflow-hidden border-slate-600">
                <div onclick="toggleSection('list-ignored')" class="bg-slate-700/30 p-4 border-b border-slate-600/50 flex justify-between items-center cursor-pointer hover:bg-slate-700/50 transition">
                    <h2 class="text-xl font-bold text-slate-400"><i class="fas fa-eye-slash mr-2"></i>Not A Reference (Ignored) <span id="count-ignored" class="bg-slate-700 text-xs px-2 py-1 rounded ml-2 text-white">0</span></h2>
                    <i id="icon-list-ignored" class="fas fa-chevron-down rotate-icon text-slate-400"></i>
                </div>
                <div id="list-ignored" class="p-4 space-y-4 hidden"></div>
            </div>

            <button onclick="location.reload()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold transition">Check Another File</button>
        </div>
    </div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const uploadSection = document.getElementById('upload-section');
        const loadingSection = document.getElementById('loading-section');
        const resultsSection = document.getElementById('results-section');

        // Drag & Drop Logic
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
        });
        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        }

        async function uploadFile(file) {
            if (file.type !== 'application/pdf') {
                alert("Please upload a PDF file.");
                return;
            }

            uploadSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload-pdf', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error("Upload failed");

                const data = await response.json();
                displayResults(data);

            } catch (error) {
                alert("Error processing file: " + error.message);
                location.reload();
            }
        }

        function displayResults(data) {
            loadingSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');

            renderList('list-verified', data.verified, 'count-verified', true);
            renderList('list-mismatch', data.edition_mismatch, 'count-mismatch', true);
            renderList('list-flawed', data.flawed_reference, 'count-flawed', true);
            renderList('list-notfound', data.not_found, 'count-notfound', false);
            // New Category
            renderList('list-ignored', data.not_reference, 'count-ignored', false);
        }

        // Dropdown Toggle Logic
        function toggleSection(listId) {
            const list = document.getElementById(listId);
            const icon = document.getElementById('icon-' + listId);
            
            if (list.classList.contains('hidden')) {
                list.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                list.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

    function renderList(elementId, items, countId, hasMatch) {
            const container = document.getElementById(elementId);
            document.getElementById(countId).textContent = items.length;
            container.innerHTML = '';

            if (!items || items.length === 0) {
                container.innerHTML = '<p class="text-slate-500 italic text-sm">No references in this category.</p>';
                return;
            }

            items.forEach(item => {
                const match = hasMatch ? (
                    item.openalex_match || 
                    item['openalex_match (edition mismatch)'] || 
                    item['openalex_match (mismatched)']
                ) : null;
                
                const original = item.original_reference;
                const note = item.note || (match ? match.note : null);
                
                // --- SOURCE DETECTION LOGIC ---
                let sourceLabel = "OpenAlex Match";
                let linkText = "View on OpenAlex";
                let colorClass = "text-blue-400"; 
                let borderClass = "border-blue-500";
                
                if (match && match.note) {
                    if (match.note.includes("WG21")) {
                        sourceLabel = "C++ Standard (WG21)";
                        linkText = "View on WG21";
                        colorClass = "text-purple-400";
                        borderClass = "border-purple-500";
                    } else if (match.note.includes("Crossref")) {
                        sourceLabel = "Crossref Match";
                        linkText = "View on Crossref";
                        colorClass = "text-yellow-400";
                        borderClass = "border-yellow-500";
                    } else if (match.note.includes("IETF")) {
                        sourceLabel = "Internet Standard (IETF)";
                        linkText = "View on IETF";
                        colorClass = "text-pink-400";
                        borderClass = "border-pink-500";
                    } else if (match.note.includes("OpenLibrary") || match.note.includes("ISBN")) {
                        sourceLabel = "Book Match (OpenLibrary)";
                        linkText = "View on OpenLibrary";
                        colorClass = "text-cyan-400";
                        borderClass = "border-cyan-500";
                    } else if (match.note.includes("Semantic Scholar")) {
                        sourceLabel = "Semantic Scholar Match";
                        linkText = "View on Semantic Scholar";
                        colorClass = "text-emerald-400"; // Green/Emerald
                        borderClass = "border-emerald-500";
                    }
                }
                // -----------------------------

                let html = `
                    <div class="bg-slate-800/50 p-4 rounded border border-slate-700">
                        <div class="text-sm text-slate-300 mb-2 break-words">
                            <span class="font-bold text-slate-500">Ref:</span> ${original}
                        </div>
                `;

                if (note) {
                     html += `<div class="text-xs text-orange-300 mb-2 italic"><i class="fas fa-info-circle"></i> ${note}</div>`;
                }

                if (match) {
                    html += `
                        <div class="mt-3 pl-3 border-l-2 ${borderClass}">
                            <div class="text-xs ${colorClass} uppercase font-bold mb-1">${sourceLabel}</div>
                            <div class="text-sm font-semibold text-white">${match.display_name}</div>
                            <div class="text-xs text-slate-400 mt-1">Year: ${match.publication_year || 'N/A'}</div>
                            
                            <a href="${match.id}" target="_blank" class="text-xs ${colorClass} hover:underline mt-1 inline-block">
                                ${linkText} &rarr;
                            </a>
                        </div>
                    `;
                } else if (!hasMatch && elementId !== 'list-ignored') {
                    html += `
                        <div class="mt-2 text-xs text-red-400">No match found in any database.</div>
                    `;
                }

                html += `</div>`;
                container.innerHTML += html;
            });
        }
    </script>
</body>
</html>